<!DOCTYPE html>
<html>
<head>
    <title>Tìm kiếm bài viết nâng cao</title>
    <!-- Thêm thư viện jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="search-container">
    <h1>Tìm kiếm bài viết nâng cao e</h1>
    <div class="search-options">
        <div class="filter-label">
            Lọc theo nhãn
            <select id="label-select">
                <option value="">Chọn nhãn</option>
            </select>
        </div>
        <div class="search-keyword">
            Tìm bài viết với từ khóa
            <form action="/search" id="ajax-search-form">
                <input aria-label="Tìm kiếm trong blog này" autocomplete="off" class="inputsearch left text" id="search-input-blogspotvn" name="q" type="text" value=""/>
            </form>
        </div>
        <div class="sort-order">
            Sắp xếp theo:
            <select id="sort-order">
                <option value="newest">Mới nhất</option>
                <option value="oldest">Cũ nhất</option>
            </select>
        </div>
    </div>
</div>
<div class="post-container">
    <div id="search-result"></div>
    <div id="load-more-container" style="display: none;">
        <button id="load-more-button">Load more</button>
    </div>
</div>

<script>
$(document).ready(function() {
    var pageToken = 1; // Trang hiện tại
    var maxResults = 10; // Số lượng bài viết mỗi lượt
    var totalResults = 0; // Tổng số kết quả tìm kiếm
    var $result_container = $('#search-result');
    var $loadMoreContainer = $('#load-more-container');

    function loadLabels() {
        $.ajax({
            url: 'https://draft.blogger.com/feeds/4739357338957377707/posts/summary?alt=json-in-script&max-results=500',
            type: 'get',
            dataType: 'jsonp',
            success: function(json) {
                var categories = json.feed.category;
                if (categories) {
                    var $labelSelect = $('#label-select');
                    categories.forEach(function(category) {
                        $labelSelect.append($('<option></option>').val(category.term).text(category.term));
                    });

                    $labelSelect.change(function() {
                        pageToken = 1; // Reset trang khi thay đổi nhãn
                        performSearch();
                    });
                }
            },
            error: function() {
                console.log('Error loading labels');
            }
        });
    }

    loadLabels();

    var $form = $('#ajax-search-form'),
        $input = $form.find(':text'),
        $labelSelect = $('#label-select');

    $input.on("input", function() {
        pageToken = 1; // Reset trang khi thay đổi từ khóa
        performSearch();
    });

    $('#sort-order').change(function() {
        pageToken = 1; // Reset trang khi thay đổi sắp xếp
        performSearch();
    });

    $('#load-more-button').on('click', function() {
        pageToken++; // Tăng trang lên 1
        performSearch();
    });

    function performSearch() {
        var keyword = $input.val().trim();
        var selectedLabel = $labelSelect.val();
        var sortOption = $('#sort-order').val();
        if (!selectedLabel && !keyword) {
            $result_container.html('');
            return;
        }

        var searchURL = 'https://draft.blogger.com/feeds/4739357338957377707/posts/summary?alt=json-in-script';
        searchURL += '&max-results=' + maxResults;
        searchURL += '&start-index=' + ((pageToken - 1) * maxResults + 1);

        if (selectedLabel && selectedLabel !== "") {
            searchURL += '&q=';
            searchURL += 'label:"' + selectedLabel + '"';
            if (keyword !== "") {
                searchURL += ' ' + encodeURIComponent(keyword);
            }
        } else if (keyword !== "") {
            searchURL += '&q=' + encodeURIComponent(keyword);
        }

        $.ajax({
            url: searchURL,
            type: 'get',
            dataType: 'jsonp',
            success: function(json) {
                var entry = json.feed.entry,
                    link, skeleton = "";
                if (typeof entry !== "undefined" && entry.length > 0) {
                    if (sortOption === 'newest') {
                        entry.sort(function(a, b) {
                            return new Date(b.published.$t) - new Date(a.published.$t);
                        });
                    } else if (sortOption === 'oldest') {
                        entry.sort(function(a, b) {
                            return new Date(a.published.$t) - new Date(b.published.$t);
                        });
                    }
                    for (var i = 0; i < entry.length; i++) {
                        for (var j = 0; j < entry[i].link.length; j++) {
                            if (entry[i].link[j].rel == "alternate") {
                                link = entry[i].link[j].href;
                            }
                        }
                        var title = entry[i].title.$t;
                        var publishedDate = entry[i].published.$t.split('T')[0];
                        var formattedDate = formatDate(publishedDate);
                        var snippet = entry[i].summary.$t.substring(0, 200) + '...';
                        var thumbnailUrl = entry[i].media$thumbnail ? entry[i].media$thumbnail.url : '';

                        skeleton += '<div class="post-search">';
                        skeleton += '<div class="thumnail-search"><img src="' + thumbnailUrl + '" alt="' + title + '"></div>';
                        skeleton += '<div class="post-time-search"><h2 class="post-title-search"><a href="' + link + '">' + title + '</a></h2>';
                        if (formattedDate) {
                            skeleton += '<div class="time-post-search">' + formattedDate + '</div></div>';
                        }
                        if (snippet) {
                            skeleton += '<div class="snipet-search">' + snippet + '</div>';
                        }
                        skeleton += '<div style="clear: both;"></div></div>';
                    }
                    $result_container.html(''); // Xóa kết quả trước đó
                    $result_container.append(skeleton);

                    // Lưu tổng số kết quả tìm kiếm
                    totalResults = parseInt(json.feed.openSearch$totalResults.$t);

                    // Hiển thị thông báo kết quả ban đầu
                    var initialResultMessage = '<div class="kq-search">Kết quả tìm kiếm';
                    if (keyword !== "") {
                        initialResultMessage += ' cho từ khoá <span class="red">“' + keyword + '”</span>';
                    }
                    if (selectedLabel && selectedLabel !== "") {
                        initialResultMessage += ' tại nhãn <span class="red">"' + selectedLabel + '"</span>';
                    }
                    initialResultMessage += ' (' + entry.length + ' kết quả)<a class="close" href="javascript:void(0);">×</a></div><div>';
                    $result_container.prepend(initialResultMessage);

                    // Kiểm tra nếu số bài viết trả về đã đủ hoặc ít hơn maxResults thì ẩn nút "Load more"
                    if ((pageToken * maxResults) >= totalResults) {
                        $loadMoreContainer.hide();
                    } else {
                        $loadMoreContainer.show();
                    }
                } else {
                    $result_container.html('');
                    $loadMoreContainer.hide(); // Ẩn nút "Load more" khi không có kết quả
                }
            },
            error: function() {
                $result_container.html('<div class="kq-search">Kết quả tìm kiếm<a class="close" href="javascript:void(0);">×</a></div><strong>Lỗi khi tải dữ liệu.</strong>');
            }
        });
    }

    function formatDate(inputDate) {
        var date = new Date(inputDate);
        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear().toString().slice(-2);
        if (day < 10) {
            day = '0' + day;
        }
        if (month < 10) {
            month = '0' + month;
        }

        return day + '.' + month + '.' + year;
    }

    // Khởi đầu, tải dữ liệu ban đầu
    performSearch();
});
</script>
<style>
h1 {text-align: center;} 
#search-result {
  clear: both;
}
.post-search {
  padding: 10px;
  margin: 10px 0;
  border-bottom: 1px solid #dddddd;
}
.thumnail-search {
  float: left;
  margin: 5px 20px 0 0;
  width: 72px;
  overflow: hidden;
}
.thumnail-search img {
  height: 72px;
  width: 72px;
  border-radius: 5px;
}
.post-time-search {
  float: left;
  margin-right: 15px;
  width: 220px;
}
.snipet-search {
  float: left;
  width: 340px;
}
.post-time-search h2 {
  font-size: 15px;
  line-height: 1.2em;
  margin: 0 0 10px 0;
  color: #12537f;
  display: block;
  font-weight: 700;
  padding: 0;
}
.search-options {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.container select option {
    min-height: 1.4em;
    font-weight: 500;
}  
  
.filter-label, .search-keyword, .sort-order {
  flex: 1;
}
.search-keyword .inputsearch {
  width: 100%;height: 40px;
}
.container select,.container input {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin: 0;
    padding: 10px;
    font-size: 16px;
    font-weight: 500;
    outline: 0;
    color: #333;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}
.container select {
    text-transform: none;
}
.kq-search {
  font-size: 15px;
}
#search-result {
  margin-top: 20px;
}
a.close {
  float: right;
  font-size: 30px;
  font-weight: bold;
  color: #ca252b;
}
.post .category, .comments {
  display: none;
}
  
#label-select::-webkit-scrollbar {
    width: 5px;
    background-color: #fff; 
}

#label-select::-webkit-scrollbar-thumb {
    border-radius: 10px; 
}

#label-select::-webkit-scrollbar-thumb:hover {
    background-color: #ddd; 
}
  
.dark #label-select::-webkit-scrollbar-thumb:hover {
    background-color: #000; 
}
.post {
    min-height: calc(80vh - 0px);
}
  
@media screen and (max-width: 1094px) {
.filter-label, .search-keyword, .sort-order {
    flex: unset;
    width: 100%;
}
</style>
</body>
</html>
