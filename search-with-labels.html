<!DOCTYPE html>
<html>
<head>
    <title>Tìm kiếm bài viết nâng cao</title>
    <!-- Thêm thư viện jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="search-container">
    <h1>Tìm kiếm bài viết nâng cao</h1>
    <div class="separator" style="clear: both;">
        <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEieLMqjoxKUbkPXg1WNVlvQrC9LI4smjfLc-JLBhGMbY9k35icjII3zFdke6-RaGBNpGetFvuR9gvJIbuEGy_zlJwencTfnKaZQTjKHZNT-KVbxs6CqEYY0PE5R8glmPcuPJ_FA2K9N6_iRcXb9y7OGYyB2csuC306858-ugLxMQumufdUzWlCPDYv3lD8K/s1600/C8D36947-CEE9-4B96-982E-66344C14D86B.png" style="display: block; padding: 1em 0; text-align: center; ">
            <img alt="" border="0" data-original-height="500" data-original-width="1500" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEieLMqjoxKUbkPXg1WNVlvQrC9LI4smjfLc-JLBhGMbY9k35icjII3zFdke6-RaGBNpGetFvuR9gvJIbuEGy_zlJwencTfnKaZQTjKHZNT-KVbxs6CqEYY0PE5R8glmPcuPJ_FA2K9N6_iRcXb9y7OGYyB2csuC306858-ugLxMQumufdUzWlCPDYv3lD8K/s1600/C8D36947-CEE9-4B96-982E-66344C14D86B.png"/>
        </a>
    </div>
    <div class="search-options">
        <div class="filter-label">
            Lọc theo nhãn
            <select id="label-select">
                <option value="">Chọn nhãn</option>
            </select>
        </div>
        <div class="search-keyword">
            Tìm bài viết với từ khóa
            <form action="/search" id="ajax-search-form">
                <input aria-label="Tìm kiếm trong blog này" autocomplete="off" class="inputsearch left text" id="search-input-blogspotvn" name="q" type="text" value=""/>
            </form>
        </div>
        <div class="sort-order">
            Sắp xếp theo:
            <select id="sort-order">
                <option value="newest">Mới nhất</option>
                <option value="oldest">Cũ nhất</option>
            </select>
        </div>
    </div>
</div>
<div id="search-result"></div>
<div id="load-more-container">
    <button id="load-more-button">Load more</button>
</div>

<script>
$(document).ready(function() {
    var pageToken = 1; // Trang hiện tại
    var maxResults = 10; // Số lượng bài viết mỗi trang

    function loadLabels() {
        $.ajax({
            url: 'https://draft.blogger.com/feeds/4739357338957377707/posts/summary?alt=json-in-script&max-results=500',
            type: 'get',
            dataType: 'jsonp',
            success: function(json) {
                var categories = json.feed.category;
                if (categories) {
                    var $labelSelect = $('#label-select');
                    categories.forEach(function(category) {
                        $labelSelect.append($('<option></option>').val(category.term).text(category.term));
                    });

                    $labelSelect.change(function() {
                        pageToken = 1; // Reset trang khi thay đổi nhãn
                        performSearch();
                    });
                }
            },
            error: function() {
                console.log('Error loading labels');
            }
        });
    }

    loadLabels();

    var $form = $('#ajax-search-form'),
        $input = $form.find(':text'),
        $labelSelect = $('#label-select');

    var $result_container = $('#search-result');

    $input.on("input", function() {
        pageToken = 1; // Reset trang khi thay đổi từ khóa
        performSearch();
    });

    $('#sort-order').change(function() {
        pageToken = 1; // Reset trang khi thay đổi sắp xếp
        performSearch();
    });

    $('#load-more-button').on('click', function() {
        pageToken++; // Tăng trang lên 1
        performSearch();
    });

    function performSearch() {
        var keyword = $input.val().trim();
        var selectedLabel = $labelSelect.val();
        var sortOption = $('#sort-order').val();
        if (!selectedLabel && !keyword) {
            $result_container.html('');
            return;
        }

        var searchURL = 'https://draft.blogger.com/feeds/4739357338957377707/posts/summary?alt=json-in-script';
        searchURL += '&max-results=' + maxResults;
        searchURL += '&start-index=' + ((pageToken - 1) * maxResults + 1);

        if (selectedLabel && selectedLabel !== "") {
            searchURL += '&q=';
            searchURL += 'label:"' + selectedLabel + '"';
            if (keyword !== "") {
                searchURL += ' ' + encodeURIComponent(keyword);
            }
        } else if (keyword !== "") {
            searchURL += '&q=' + encodeURIComponent(keyword);
        }

        $result_container.show().html('Loading...');

        $.ajax({
            url: searchURL,
            type: 'get',
            dataType: 'jsonp',
            success: function(json) {
                var entry = json.feed.entry,
                    link, skeleton = "";
                if (typeof entry !== "undefined" && entry.length > 0) {
                    if (sortOption === 'newest') {
                        entry.sort(function(a, b) {
                            return new Date(b.published.$t) - new Date(a.published.$t);
                        });
                    } else if (sortOption === 'oldest') {
                        entry.sort(function(a, b) {
                            return new Date(a.published.$t) - new Date(b.published.$t);
                        });
                    }
                    skeleton = '<div class="kq-search">Kết quả tìm kiếm';
                    if (keyword !== "") {
                        skeleton += ' cho từ khoá <span class="red">“' + keyword + '”</span>';
                    }
                    if (selectedLabel && selectedLabel !== "") {
                        skeleton += ' tại nhãn <span class="red">"' + selectedLabel + '"</span>';
                    }
                    skeleton += ' (' + entry.length + ' kết quả)<a class="close" href="javascript:void(0);">×</a></div><div>';
                    for (var i = 0; i < entry.length; i++) {
                        for (var j = 0; j < entry[i].link.length; j++) {
                            if (entry[i].link[j].rel == "alternate") {
                                link = entry[i].link[j].href;
                            }
                        }
                        var title = entry[i].title.$t;
                        var publishedDate = entry[i].published.$t.split('T')[0];
                        var formattedDate = formatDate(publishedDate);
                        var snippet = entry[i].summary.$t.substring(0, 200) + '...';
                        var thumbnailUrl = entry[i].media$thumbnail ? entry[i].media$thumbnail.url : '';

                        skeleton += '<div class="post-search">';
                        skeleton += '<div class="thumnail-search"><img src="' + thumbnailUrl + '" alt="' + title + '"></div>';
                        skeleton += '<div class="post-time-search"><h2 class="post-title-search"><a href="' + link + '">' + title + '</a></h2>';
                        if (formattedDate) {
                            skeleton += '<div class="time-post-search">' + formattedDate + '</div></div>';
                        }
                        if (snippet) {
                            skeleton += '<div class="snipet-search">' + snippet + '</div>';
                        }
                        skeleton += '<div style="clear: both;"></div></div>';
                    }
                    skeleton += '</div>';
                    $result_container.html(skeleton);

                    // Kiểm tra nếu số bài viết trả về là ít hơn maxResults thì ẩn nút "Load more"
                    if (entry.length < maxResults) {
                        $('#load-more-container').hide();
                    } else {
                        $('#load-more-container').show();
                    }
                } else {
                    $result_container.html('');
                    $('#load-more-container').hide(); // Ẩn nút "Load more" khi không có kết quả
                }
            },
            error: function() {
                $result_container.html('<div class="kq-search">Kết quả tìm kiếm<a class="close" href="javascript:void(0);">×</a></div><strong>Lỗi khi tải dữ liệu.</strong>');
            }
        });
    }

    function formatDate(inputDate) {
        var date = new Date(inputDate);
        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear().toString().slice(-2);
        if (day < 10) {
            day = '0' + day;
        }
        if (month < 10) {
            month = '0' + month;
        }

        return day + '.' + month + '.' + year;
    }
});
</script>
</body>
</html>
